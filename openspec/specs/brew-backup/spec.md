# Brew Backup

## Purpose
The `den brew upgrade` command provides automated Homebrew maintenance and backup functionality for the den CLI application. This feature runs `brew upgrade` to update all installed packages, generates a Brewfile snapshot, uses Anthropic's API to document and categorize the Brewfile contents, and backs up the formatted Brewfile to a GitHub Gist. The system tracks changes via content hashing to avoid unnecessary API calls and Gist updates when the Brewfile hasn't changed.

## Requirements

### Requirement: Homebrew Upgrade Execution

The system SHALL execute `brew upgrade` to update all installed packages.

#### Scenario: Successful upgrade
- **WHEN** a user runs `den brew upgrade`
- **THEN** the system SHALL execute `brew upgrade` to update all installed packages
- **AND** the system SHALL display "Updating Homebrew dependencies..." to indicate progress

#### Scenario: Upgrade failure
- **WHEN** `brew upgrade` fails
- **THEN** the system SHALL display an error message and exit with a non-zero status code

### Requirement: Brewfile Generation

The system SHALL generate a Brewfile snapshot after upgrading.

#### Scenario: Generate Brewfile
- **WHEN** generating the Brewfile
- **THEN** the system SHALL execute `brew bundle dump --force` to create the Brewfile content
- **AND** the system SHALL display "Creating Brewfile..." to indicate progress

#### Scenario: Compute content hash
- **WHEN** the Brewfile is generated
- **THEN** the system SHALL compute a SHA-256 hash of the content

#### Scenario: Skip unchanged Brewfile
- **WHEN** the new Brewfile hash matches the hash stored in state.json AND the `--force` flag is not provided
- **THEN** the system SHALL skip formatting and backup, displaying "Brewfile unchanged, skipping backup"

#### Scenario: Process changed Brewfile
- **WHEN** the Brewfile hash differs from the stored hash OR no hash exists in state.json
- **THEN** the system SHALL proceed to format the Brewfile

#### Scenario: Force flag overrides hash check
- **WHEN** the user provides the `--force` flag
- **THEN** the system SHALL proceed to format and backup the Brewfile regardless of whether the hash has changed

### Requirement: AI Brewfile Formatting

The system SHALL use Anthropic's API to document and categorize the Brewfile.

#### Scenario: Format with AI
- **WHEN** formatting the Brewfile
- **THEN** the system SHALL send the raw Brewfile content to the Anthropic API
- **AND** the system SHALL display "Formatting Brewfile with AI..." to indicate progress

#### Scenario: Header generation
- **WHEN** requesting formatting
- **THEN** the system SHALL instruct Anthropic to add a header comment block noting the file was generated by `den` with usage instructions

#### Scenario: Inline descriptions
- **WHEN** requesting formatting
- **THEN** the system SHALL instruct Anthropic to add inline description comments at the end of each package line

#### Scenario: Category organization
- **WHEN** requesting formatting
- **THEN** the system SHALL instruct Anthropic to organize packages into logical categories with decorated section headers

#### Scenario: Missing API key
- **WHEN** the Anthropic API key is not configured
- **THEN** the system SHALL display an error message instructing the user to run `den auth login`

#### Scenario: API failure
- **WHEN** the Anthropic API call fails
- **THEN** the system SHALL display an error message with details and exit with a non-zero status code

#### Scenario: Package preservation
- **WHEN** formatting a Brewfile and then parsing the formatted output
- **THEN** the system SHALL preserve all original package entries

### Requirement: GitHub Gist Backup

The system SHALL back up the formatted Brewfile to a GitHub Gist.

#### Scenario: Create new Gist
- **WHEN** backing up to GitHub and no Gist ID is stored in state.json
- **THEN** the system SHALL create a new Gist

#### Scenario: Update existing Gist
- **WHEN** backing up to GitHub and a Gist ID is stored in state.json
- **THEN** the system SHALL update the existing Gist

#### Scenario: Backup progress
- **WHEN** backing up
- **THEN** the system SHALL display "Backing up Brewfile to GitHub Gist..." to indicate progress

#### Scenario: Store Gist ID
- **WHEN** the Gist is created
- **THEN** the system SHALL store the Gist ID in state.json under the "brew" key

#### Scenario: Display Gist URL
- **WHEN** the Gist operation succeeds
- **THEN** the system SHALL display the Gist URL to the user

#### Scenario: Missing GitHub token
- **WHEN** the GitHub token is not configured
- **THEN** the system SHALL display an error message instructing the user to configure GitHub authentication

#### Scenario: GitHub API failure
- **WHEN** the GitHub API call fails
- **THEN** the system SHALL display an error message with details and exit with a non-zero status code

### Requirement: State Persistence

The system SHALL persist brew state across runs.

#### Scenario: State file location
- **WHEN** storing brew state
- **THEN** the system SHALL save to `~/.config/den/state.json` under the "brew" key

#### Scenario: Create state file
- **WHEN** the state.json file does not exist
- **THEN** the system SHALL create the file with the brew state

#### Scenario: Merge state
- **WHEN** the state.json file exists
- **THEN** the system SHALL merge the brew state with existing content

#### Scenario: Store hash
- **WHEN** saving brew state
- **THEN** the system SHALL store the Brewfile content hash

#### Scenario: Store Gist ID
- **WHEN** saving brew state after successful backup
- **THEN** the system SHALL store the GitHub Gist ID

#### Scenario: State round-trip
- **WHEN** serializing brew state to JSON and deserializing it back
- **THEN** the system SHALL produce equivalent state values

### Requirement: Logging

The system SHALL log detailed information about the brew upgrade process.

#### Scenario: Log file location
- **WHEN** the brew upgrade process runs
- **THEN** the system SHALL log all operations to `~/.config/den/logs/brew-upgrade.log`

#### Scenario: Create log directory
- **WHEN** the log directory does not exist
- **THEN** the system SHALL create `~/.config/den/logs/` with appropriate permissions

#### Scenario: Timestamp format
- **WHEN** logging
- **THEN** the system SHALL include timestamps with each log entry

#### Scenario: Log level format
- **WHEN** logging
- **THEN** the system SHALL include the log level (INFO, ERROR, WARNING) with each entry

#### Scenario: Error logging
- **WHEN** an error occurs
- **THEN** the system SHALL log the full error details including stack traces

### Requirement: Progress Feedback

The system SHALL provide clear progress feedback during the process.

#### Scenario: Step status
- **WHEN** each major step begins
- **THEN** the system SHALL display a status message to the console

#### Scenario: Completion summary
- **WHEN** the entire process completes successfully
- **THEN** the system SHALL display a summary message with the Gist URL

#### Scenario: Skip indication
- **WHEN** the process is skipped due to unchanged Brewfile
- **THEN** the system SHALL clearly indicate no backup was needed

#### Scenario: Failure indication
- **WHEN** any step fails
- **THEN** the system SHALL display which step failed and why
