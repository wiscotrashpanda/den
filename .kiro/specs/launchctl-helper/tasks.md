# Implementation Plan

- [x] 1. Set up launchctl module structure and config reader
  - [x] 1.1 Create `src/den/launchctl_config.py` with `get_domain()` function
    - Read domain from `~/.config/den/config.json`
    - Return `com.example` as default when file missing or domain key absent
    - Handle invalid JSON gracefully
    - _Requirements: 2.1, 2.2, 2.3_
  - [x] 1.2 Write unit tests for config reader
    - Test with missing file, empty file, valid JSON, invalid JSON
    - _Requirements: 2.1, 2.2, 2.3_
  - [x] 1.3 Commit and push changes to Git
    - Stage and commit config reader and tests
    - Push to remote repository

- [x] 2. Implement input validators
  - [x] 2.1 Create `src/den/launchctl_validator.py` with validation functions
    - `validate_task_name()`: Allow alphanumeric, hyphens, underscores only
    - `validate_command()`: Reject empty strings
    - `validate_interval()`: Accept positive integers only
    - `validate_hour()`: Accept 0-23 range only
    - `validate_minute()`: Accept 0-59 range only
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_
  - [x] 2.2 Write property test for task name validation
    - **Property 7: Task Name Character Validation**
    - **Validates: Requirements 6.2**
  - [x] 2.3 Write property test for interval validation
    - **Property 8: Interval Validation**
    - **Validates: Requirements 6.4**
  - [x] 2.4 Write property test for hour validation
    - **Property 9: Hour Validation**
    - **Validates: Requirements 6.5**
  - [x] 2.5 Write property test for minute validation
    - **Property 10: Minute Validation**
    - **Validates: Requirements 6.6**
  - [x] 2.6 Commit and push changes to Git
    - Stage and commit validators and property tests
    - Push to remote repository

- [x] 3. Implement plist generator and parser
  - [x] 3.1 Create `src/den/plist_generator.py` with TaskConfig dataclass and generation
    - Define `TaskConfig` dataclass with label, program_arguments, scheduling fields
    - Implement `generate_plist()` to produce valid XML plist content
    - Implement `parse_plist()` to parse XML back to TaskConfig
    - Use Python's `plistlib` for XML handling
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7_
  - [x] 3.2 Write property test for plist round-trip
    - **Property 1: Plist Round-Trip Consistency**
    - **Validates: Requirements 5.7**
  - [x] 3.3 Write property test for label correctness
    - **Property 2: Label Matches Configuration**
    - **Validates: Requirements 5.2**
  - [x] 3.4 Write property test for command preservation
    - **Property 3: Command Arguments Preserved**
    - **Validates: Requirements 5.3**
  - [x] 3.5 Write property test for schedule preservation
    - **Property 4: Schedule Configuration Preserved**
    - **Validates: Requirements 5.4, 5.5**
  - [x] 3.6 Commit and push changes to Git
    - Stage and commit plist generator and property tests
    - Push to remote repository

- [x] 4. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 5. Implement plist scanner
  - [x] 5.1 Create `src/den/plist_scanner.py` with scanning functions
    - Implement `scan_domain_agents()` to find matching plist files
    - Implement `extract_task_name()` to get task name from filename
    - Implement `build_plist_path()` to construct full path from domain and task
    - _Requirements: 4.1, 2.4, 2.5_
  - [x] 5.2 Write property test for domain scanning
    - **Property 6: Domain Prefix Scanning Correctness**
    - **Validates: Requirements 4.1**
  - [x] 5.3 Write property test for filename format
    - **Property 5: Filename Format Correctness**
    - **Validates: Requirements 2.4**
  - [x] 5.4 Commit and push changes to Git
    - Stage and commit plist scanner and property tests
    - Push to remote repository

- [x] 6. Implement launchctl runner
  - [x] 6.1 Create `src/den/launchctl_runner.py` with load/unload functions
    - Implement `load_agent()` to execute `launchctl load`
    - Implement `unload_agent()` to execute `launchctl unload`
    - Define `LaunchctlError` exception class
    - _Requirements: 3.1, 3.2, 3.3, 4.3, 4.4_
  - [x] 6.2 Write unit tests for launchctl runner with mocked subprocess
    - Test successful load/unload
    - Test error handling for failed commands
    - _Requirements: 3.1, 3.2, 3.3, 4.3, 4.4_
  - [x] 6.3 Commit and push changes to Git
    - Stage and commit launchctl runner and unit tests
    - Push to remote repository

- [x] 7. Implement launchctl commands
  - [x] 7.1 Create `src/den/commands/launchctl.py` with install command
    - Prompt for task name with validation loop
    - Prompt for command to execute
    - Prompt for scheduling type (interval or calendar)
    - Prompt for schedule values based on type
    - Generate plist, write to LaunchAgents directory, load agent
    - Display success/error messages
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 3.1, 3.2, 3.3_
  - [x] 7.2 Add uninstall command to `src/den/commands/launchctl.py`
    - Scan for matching plist files using configured domain
    - Display numbered list of available tasks
    - Prompt user to select task
    - Unload agent and delete plist file
    - Handle case when no tasks found
    - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_
  - [x] 7.3 Register launchctl command group in `src/den/main.py`
    - Import and add `launchctl_app` typer to main app
    - _Requirements: 1.1, 4.1_
  - [x] 7.4 Commit and push changes to Git
    - Stage and commit launchctl commands and main.py changes
    - Push to remote repository

- [x] 8. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.
